name: CI Pipeline

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - develop
      - feature/*

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov requests
    
    - name: Lint code
      run: |
        pip install flake8 black
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        echo "Linting complete"
    
    - name: Test imports
      run: |
        python -c "from app import app; print('✓ API imports successfully')"
        python -c "import fastapi, uvicorn, pandas, sklearn, joblib; print('✓ All dependencies available')"
    
    - name: Test API structure
      run: |
        python -c "
        from app import app, HeartDiseaseInput, PredictionResponse
        from fastapi.testclient import TestClient
        client = TestClient(app)
        
        # Test root endpoint
        response = client.get('/')
        assert response.status_code == 200
        print('✓ Root endpoint works')
        
        # Test health endpoint
        response = client.get('/health')
        assert response.status_code == 200
        print('✓ Health endpoint works')
        
        print('✓ All API structure tests passed')
        "
    
    - name: Check model files
      run: |
        if [ -f "models/best_logreg_pipeline.joblib" ] || [ -f "models/best_randomforest_pipeline.joblib" ]; then
          echo "✓ Model files present"
          python -c "
          from joblib import load
          import os
          model_files = [f for f in os.listdir('models') if f.endswith('.joblib')]
          for f in model_files:
              try:
                  model = load(f'models/{f}')
                  print(f'✓ {f} loads successfully')
              except Exception as e:
                  print(f'✗ {f} failed to load: {e}')
          "
        else
          echo "⚠ No model files found (this is OK for CI)"
        fi

